<html>
	<head>
		<title>AArcade Metaverse: Spectate</title>
		<link rel="stylesheet" type="text/css" href="spectate.css" />
		<script src="scripts/metaverse.js"></script>
		<script src="scripts/md5.min.js"></script>
		<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>

		<script>
			var metaverse = new Metaverse();
			var error;
			//var g_userId = "WebUser" + Date.now();
		</script>
	</head>
	<body>
		<div class="container" style="display: block;">
			<h1>AArcade Metaverse</h1>
			<div id="metaverse">
				<center>
					<form>
						<input type="button" value="Quick Join" style="font-weight: 900;" /><br />
						<input type="button" value="Connect to Firebase" />
						<input type="button" value="Host Firebase" />
						<input type="button" value="Load Local Session" />
						<input type="button" value="New Local Session" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Connect to Firebase</h1>
			<div id="firebase">
				<center>
					<form>
						<label>Firebase Address: <input type="text" value="https://metaverse.firebaseio.com/" /></label>
						<input type="submit" value="Connect" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Join a Universe</h1>
			<div id="universe">
				<center>
					<form>
						<select></select><br />
						<input type="submit" value="Join Universe" />
						<input type="button" value="New Universe" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>New Universe</h1>
			<div id="newUniverse">
				<center>
					<form>
						<label><font class="labelText">Universe Name: </font><input type="text" /></label>
						<input type="submit" value="Create Universe" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Dashboard</h1>
			<div id="dashboard">
				<center>
					<form>
						<input type="button" value="Metaverse Library" />
						<input type="button" value="Log-In" />
						<input type="button" value="Sign-Up" />
						<input type="button" value="Account" />
						<input type="button" value="Disconnect" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Sign-Up</h1>
			<div id="signUp">
				<center>
					<form>
						<label><font class="labelText">Username: </font><input type="text" /></label>
						<label><font class="labelText"><u>Public</u> Passcode: </font><input type="password" /></label>
						<label><font class="labelText">Display Name: </font><input type="text" /></label>
						<input type="submit" value="Sign-Up" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Log-In</h1>
			<div id="logIn">
				<center>
					<form>
						<label><font class="labelText">Username: </font><input type="text" /></label>
						<label><font class="labelText"><u>Public</u> Passcode: </font><input type="password" /></label>
						<input type="submit" value="Log-In" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Account</h1>
			<div id="account">
				<center>
					<form>
						<label><font class="labelText">Metaverse: </font><input type="text" disabled="true" /></label>
						<label><font class="labelText">Universe: </font><input type="text" disabled="true" /></label>
						<label><font class="labelText">Username: </font><input type="text" disabled="true" /></label>
						<label><font class="labelText">Display Name: </font><input type="text" /></label>

						<div class="passcodes" style="display: none;">
							<br />
							<label><font class="labelText">Old <u>Public</u> Passcode: </font><input type="password" id="passCode" /></label>
							<label><font class="labelText">New <u>Public</u> Passcode: </font><input type="password" id="passCode" /></label>
							<label><font class="labelText">New Passcode Again: </font><input type="password" id="passCode" /></label>
						</div>

						<input type="button" value="Change Passcode" />
						<input type="submit" value="Save" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Metaverse Library</h1>
			<div id="metaverseLibrary">
				<center>
					<form>
						<input type="button" value="Items" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Metaverse Library / Items</h1>
			<div id="metaverseLibraryItems">
				<center>
					<form>
						<select size="10"></select>
						<div class="itemContainer"></div>
						<input type="submit" value="Edit Selected" disabled="true" />
						<input type="button" value="Create New" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Metaverse Library / Items / Create New</h1>
			<div id="metaverseLibraryItemsCreate">
				<center>
					<form>
						<label><font class="labelText">Shortcut: </font><input type="text" /></label>
						<input type="submit" value="Create" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<div class="container">
			<h1>Metaverse Library / Items / Edit Item</h1>
			<div id="metaverseLibraryItemsEditItem">
				<center>
					<form>
						<label><font class="labelText">ID: </font><input type="text" disabled="true" /></label>
						<label><font class="labelText">App: </font><input type="text" /></label>
						<label><font class="labelText">Description: </font><input type="text" /></label>
						<label><font class="labelText">File: </font><input type="text" /></label>
						<label><font class="labelText">Marquee: </font><input type="text" /></label>
						<label><font class="labelText">Model: </font><input type="text" /></label>
						<label><font class="labelText">Preview: </font><input type="text" /></label>
						<label><font class="labelText">Reference: </font><input type="text" /></label>
						<label><font class="labelText">Screen: </font><input type="text" /></label>
						<label><font class="labelText">Title: </font><input type="text" /></label>
						<label><font class="labelText">Type: </font><input type="text" /></label>
						<input type="submit" value="Save" />
						<input type="button" value="Cancel" />
					</form>
				</center>
			</div>
		</div>

		<script>
			var metaverseElem = document.querySelector("#metaverse");
			var metaverseButtons = metaverseElem.querySelectorAll("input[type='button']");
			var metaverseQuickButton = metaverseButtons[0];
			var metaverseConnectButton = metaverseButtons[1];

			var firebaseElem = document.querySelector("#firebase");
			var firebaseCancelButton = firebaseElem.querySelector("input[type='button']");

			var dashboardElem = document.querySelector("#dashboard");
			var dashboardButtons = dashboardElem.querySelectorAll("input[type='button']");
			var dashboardMetaverseLibraryButton = dashboardButtons[0];
			var dashboardLogInButton = dashboardButtons[1];
			var dashboardSignUpButton = dashboardButtons[2];
			var dashboardAccountButton = dashboardButtons[3];
			var dashboardDisconnectButton = dashboardButtons[4];

			var universeElem = document.querySelector("#universe");
			var universeUniverseSelect = universeElem.querySelector("select");
			var universeButtons = universeElem.querySelectorAll("input[type='button'], input[type='submit']");
			var universeJoinButton = universeButtons[0];
			var universeNewButton = universeButtons[1];
			var universeCancelButton = universeButtons[2];

			var newUniverseElem = document.querySelector("#newUniverse");
			var newUniverseButtons = newUniverseElem.querySelectorAll("input[type='button'], input[type='submit']");
			var newUniverseCreateButton = newUniverseButtons[0];
			var newUniverseCancelButton = newUniverseButtons[1];

			var signUpElem = document.querySelector("#signUp");
			var signUpFields = signUpElem.querySelectorAll("input[type='text'], input[type='password']");
			var signUpUsername = signUpFields[0];
			var signUpPasscode = signUpFields[1];
			var signUpDisplayName = signUpFields[2];
			var signUpCancelButton = signUpElem.querySelector("input[type='button']");

			var logInElem = document.querySelector("#logIn");
			var logInButtons = logInElem.querySelectorAll("input[type='button'], input[type='submit']");
			var logInLogInButton = logInButtons[0];
			var logInCancelButton = logInButtons[1];
			var logInFields = logInElem.querySelectorAll("input[type='text'], input[type='password']");
			var logInUsername = logInFields[0];
			var logInPasscode = logInFields[1];

			var metaverseLibraryElem = document.querySelector("#metaverseLibrary");
			var metaverseLibraryButtons = metaverseLibraryElem.querySelectorAll("input[type='button'], input[type='submit']");
			var metaverseLibraryItemsButton = metaverseLibraryButtons[0];
			var metaverseLibraryCancelButton = metaverseLibraryButtons[1];

			var metaverseLibraryItemsElem = document.querySelector("#metaverseLibraryItems");
			var metaverseLibraryItemsSelect = metaverseLibraryItemsElem.querySelector("select");
			var metaverseLibraryItemsButtons = metaverseLibraryItemsElem.querySelectorAll("input[type='button'], input[type='submit']");
			var metaverseLibraryItemsEditButton = metaverseLibraryItemsButtons[0];
			var metaverseLibraryItemsCreateButton = metaverseLibraryItemsButtons[1];
			var metaverseLibraryItemsCancelButton = metaverseLibraryItemsButtons[2];

			var metaverseLibraryItemsCreateElem = document.querySelector("#metaverseLibraryItemsCreate");
			var metaverseLibraryItemsCreateFields = metaverseLibraryItemsCreateElem.querySelectorAll("input[type='text'], input[type='password']");
			var metaverseLibraryItemsCreateButtons = metaverseLibraryItemsCreateElem.querySelectorAll("input[type='button'], input[type='submit']");
			var metaverseLibraryItemsCreateCancelButton = metaverseLibraryItemsCreateButtons[1];
			var metaverseLibraryItemsCreateFile = metaverseLibraryItemsCreateFields[0];

			var metaverseLibraryItemsEditItemElem = document.querySelector("#metaverseLibraryItemsEditItem");
			var metaverseLibraryItemsEditItemButtons = metaverseLibraryItemsEditItemElem.querySelectorAll("input[type='button'], input[type='submit']");
			var metaverseLibraryItemsEditItemSaveButton = metaverseLibraryItemsEditItemButtons[0];
			var metaverseLibraryItemsEditItemCancelButton = metaverseLibraryItemsEditItemButtons[1];
			var metaverseLibraryItemsEditItemFields = metaverseLibraryItemsEditItemElem.querySelectorAll("input[type='text'], input[type='password']");
			var metaverseLibraryItemsEditItemId = metaverseLibraryItemsEditItemFields[0];
			var metaverseLibraryItemsEditItemApp = metaverseLibraryItemsEditItemFields[1];
			var metaverseLibraryItemsEditItemDescription = metaverseLibraryItemsEditItemFields[2];
			var metaverseLibraryItemsEditItemFile = metaverseLibraryItemsEditItemFields[3];
			var metaverseLibraryItemsEditItemMarquee = metaverseLibraryItemsEditItemFields[4];
			var metaverseLibraryItemsEditItemModel = metaverseLibraryItemsEditItemFields[5];
			var metaverseLibraryItemsEditItemPreview = metaverseLibraryItemsEditItemFields[6];
			var metaverseLibraryItemsEditItemReference = metaverseLibraryItemsEditItemFields[7];
			var metaverseLibraryItemsEditItemScreen = metaverseLibraryItemsEditItemFields[8];
			var metaverseLibraryItemsEditItemTitle = metaverseLibraryItemsEditItemFields[9];
			var metaverseLibraryItemsEditItemType = metaverseLibraryItemsEditItemFields[10];

			var accountElem = document.querySelector("#account");
			var accountButtons = accountElem.querySelectorAll("input[type='button'], input[type='submit']");
			var accountChangePasscodeButton = accountButtons[0];
			var accountCancelButton = accountButtons[2];
			var accountFields = accountElem.querySelectorAll("input[type='text'], input[type='password']");
			var accountMetaverse = accountFields[0];
			var accountUniverse = accountFields[1];
			var accountUsername = accountFields[2];
			var accountDisplayName = accountFields[3];
			var accountOldPublicPasscode = accountFields[4];
			var accountNewPublicPasscode = accountFields[5];
			var accountNewPublicPasscodeAgain = accountFields[6];

			var elems, i;
			metaverse.addEventListener("reset", function(e)
			{
				firebaseElem.querySelector("input[type='text']").value = "https://metaverse.firebaseio.com/";

				elems = metaverseElem.querySelectorAll("input");
				for( i = 0; i < elems.length; i++ )
					elems[i].disabled = false;

				elems = firebaseElem.querySelectorAll("input");
				for( i = 0; i < elems.length; i++ )
					elems[i].disabled = false;

				elems = dashboardElem.querySelectorAll("input");
				for( i = 0; i < elems.length; i++ )
					elems[i].disabled = false;
			});

			function freezeInputs(parentElem)
			{
				var i;
				var elems = parentElem.querySelectorAll("input");
				for( i = 0; i < elems.length; i++ )
					elems[i].disabled = true;
			}

			function unfreezeInputs(parentElem)
			{
				var i;
				var elems = parentElem.querySelectorAll("input");
				for( i = 0; i < elems.length; i++ )
					elems[i].disabled = false;
			}

			function showSlate(slateElem)
			{
				unfreezeInputs(slateElem);

				slateElem.parentNode.style.display = "block";

				if( slateElem === newUniverseElem )
				{
					newUniverseElem.querySelector("input[type='text']").value = "";
				}
				else if( slateElem === accountElem )
				{
					accountMetaverse.value = metaverse.root;
					accountMetaverse.disabled = true;

					accountUniverse.value = metaverse.universe;
					accountUniverse.disabled = true;

					accountUsername.value = metaverse.localUser.username;
					accountUsername.disabled = true;

					accountDisplayName.value = metaverse.localUser.displayName;

					accountChangePasscodeButton.style.display = "block";

					accountElem.querySelector(".passcodes").style.display = "none";
					accountOldPublicPasscode.value = "";
					accountNewPublicPasscode.value = "";
					accountNewPublicPasscodeAgain.value = "";
				}
				else if( slateElem === metaverseElem )
				{
					firebaseElem.querySelector("input[type='text']").value = "https://metaverse.firebaseio.com/";
				}
				else if( slateElem === logInElem )
				{
					logInUsername.value = "";
					logInPasscode.value = "";
				}
				else if( slateElem === signUpElem )
				{
					signUpUsername.value = "";
					signUpPasscode.value = "";
					signUpDisplayName.value = "";
				}
				else if( slateElem === universeElem )
				{
					universeUniverseSelect.options.length = 0;

					var option;
					var x;
					for( x in metaverse.universeNames )
					{
						option = document.createElement("option");
						option.value = x;
						option.text = metaverse.universeNames[x] + " (" + x + ")";
						universeUniverseSelect.appendChild(option);
					}

					if( universeUniverseSelect.options.length > 0 )
						universeJoinButton.disabled = false;
					else
						universeJoinButton.disabled = true;
				}
				else if( slateElem === firebaseElem )
					firebaseElem.querySelector("input[type='text']").value = "https://metaverse.firebaseio.com/";
				else if( slateElem === metaverseLibraryItemsElem )
				{
					metaverseLibraryItemsEditButton.disabled = true;

					metaverseLibraryItemsSelect.options.length = 0;

					var x, rawItem, item, itemOption;
					for( x in metaverse.library.items )
					{
						rawItem = metaverse.library.items[x];
						item = metaverse.cookItem(rawItem);

						itemOption = document.createElement("option");
						itemOption.value = x;
						itemOption.text = item.title;
						
						metaverseLibraryItemsSelect.appendChild(itemOption);
					}
				}
				else if( slateElem === metaverseLibraryItemsElem )
				{




				}
				else if( slateElem === dashboardElem )
				{
					if( metaverse.localUser.id !== "annon" )
					{
						dashboardLogInButton.style.display = "none";
						dashboardSignUpButton.style.display = "none";
						dashboardAccountButton.style.display = "block";
					}
					else
					{
						dashboardLogInButton.style.display = "block";
						dashboardSignUpButton.style.display = "block";
						dashboardAccountButton.style.display = "none";
					}
				}
			}

			function hideSlate(slateElem)
			{
				slateElem.parentNode.style.display = "none";
			}

			metaverseLibraryItemsEditItemElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				var item =
				{
					"info":
					{
						"id": metaverseLibraryItemsEditItemId.value
					}
				};

				item.app = metaverseLibraryItemsEditItemApp.value;
				item.description = metaverseLibraryItemsEditItemDescription.value;
				item.file = metaverseLibraryItemsEditItemFile.value;
				item.marquee = metaverseLibraryItemsEditItemMarquee.value;
				item.model = metaverseLibraryItemsEditItemModel.value;
				item.preview = metaverseLibraryItemsEditItemPreview.value;
				item.reference = metaverseLibraryItemsEditItemReference.value;
				item.screen = metaverseLibraryItemsEditItemScreen.value;
				item.title = metaverseLibraryItemsEditItemTitle.value;
				item.type = metaverseLibraryItemsEditItemType.value;

				metaverse.updateItem(item, function(error)
				{
					hideSlate(metaverseLibraryItemsEditItemElem);
					showSlate(metaverseLibraryItemsElem);
				});
			});

			metaverseLibraryItemsSelect.addEventListener("change", function(e)
			{
				if( metaverseLibraryItemsSelect.selectedIndex !== -1 )
					metaverseLibraryItemsEditButton.disabled = false;
			});

			metaverseLibraryItems.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				hideSlate(metaverseLibraryItemsElem);

				var itemId = metaverseLibraryItemsSelect.options[metaverseLibraryItemsSelect.selectedIndex].value;
				var rawItem = metaverse.library.items[itemId];
				item = metaverse.cookItem(rawItem);

				metaverseLibraryItemsEditItemId.value = item.info.id;
				metaverseLibraryItemsEditItemApp.value = item.app;
				metaverseLibraryItemsEditItemDescription.value = item.description;
				metaverseLibraryItemsEditItemFile.value = item.file;
				metaverseLibraryItemsEditItemMarquee.value = item.marquee;
				metaverseLibraryItemsEditItemModel.value = item.model;
				metaverseLibraryItemsEditItemPreview.value = item.preview;
				metaverseLibraryItemsEditItemReference.value = item.reference;
				metaverseLibraryItemsEditItemTitle.value = item.title;
				metaverseLibraryItemsEditItemType.value = item.type;

				showSlate(metaverseLibraryItemsEditItemElem);

				metaverseLibraryItemsEditItemId.disabled = true;
			});

			metaverseQuickButton.addEventListener("click", function(e)
			{
				freezeInputs(metaverseElem);

				// Connect to the firebase.
				metaverse.connect(firebaseElem.querySelector("input[type='text']").value, function(error)
				{
					if( !!error )
					{
						unfreezeInputs(metaverseElem);

						console.log(error);
						alert(error);
					}
					else
					{
						hideSlate(metaverseElem);

						if( universeUniverseSelect.options.length > 0 )
							universeJoinButton.disabled = false;
						else
							universeJoinButton.disabled = true;

						showSlate(universeElem);
					}
				});
			}, true);

			metaverseConnectButton.addEventListener("click", function(e)
			{
				e.preventDefault();

				hideSlate(metaverseElem);
				showSlate(firebaseElem);
			});

			metaverseLibraryItemsEditItemCancelButton.addEventListener("click", function(e)
			{
				hideSlate(metaverseLibraryItemsEditItemElem);
				showSlate(metaverseLibraryItemsElem);
			});

			firebaseCancelButton.addEventListener("click", function(e)
			{
				hideSlate(firebaseElem);
				showSlate(metaverseElem);
			}, true);

			firebaseElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				freezeInputs(firebaseElem);

				metaverse.connect(firebaseElem.querySelector("input[type='text']").value, function(error)
				{
					if( !!error )
					{
						unfreezeInputs(firebaseElem);

						console.log(error);
						alert(error);
					}
					else
					{
						hideSlate(firebaseElem);
						showSlate(universeElem);
					}
				});
			}, true);

			universeNewButton.addEventListener("click", function(e)
			{
				hideSlate(universeElem);
				showSlate(newUniverseElem);
			}, true);

			universeCancelButton.addEventListener("click", function(e)
			{
				hideSlate(universeElem);
				metaverse.reset();
				showSlate(metaverseElem);
			}, true);

			universeElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				var value = universeUniverseSelect.options[universeUniverseSelect.selectedIndex].value;
				metaverse.joinUniverse(value, function()
				{
					hideSlate(universeElem);

//					dashboardElem.parentNode.querySelector("h1").innerHTML = "Welcome to " + metaverse.getUniverseName(metaverse.universe);

					showSlate(dashboardElem);
				});
			}, true);

			newUniverseCancelButton.addEventListener("click", function(e)
			{
				hideSlate(newUniverseElem);
				showSlate(universeElem);
			}, true);

			newUniverseElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				var name = newUniverseElem.querySelector("input[type='text']").value;
				
				if( !name || name.length <= 5 )
				{
					error = "ERROR: Universe name must be at least 6 characters long."
					console.log(error);
					alert(error);
					return;
				}

				freezeInputs(newUniverseElem);

				metaverse.createUniverse(name, function(resultId)
				{
					hideSlate(newUniverseElem);

					showSlate(universeElem);

					universeUniverseSelect.value = resultId;

					var submitButton = universeElem.querySelector("input[type='submit']");
					submitButton.click();

					dashboardSignUpButton.click();
				});
			}, true);

			dashboardDisconnectButton.addEventListener("click", function(e)
			{
				hideSlate(dashboardElem);
				metaverse.reset();
				showSlate(metaverseElem);
			}, true);

			dashboardSignUpButton.addEventListener("click", function(e)
			{
				hideSlate(dashboardElem);
				showSlate(signUpElem);
			}, true);

			dashboardMetaverseLibraryButton.addEventListener("click", function(e)
			{
				hideSlate(dashboardElem);
				showSlate(metaverseLibraryElem);
			}, true);

			dashboardAccountButton.addEventListener("click", function(e)
			{
				hideSlate(dashboardElem);
				showSlate(accountElem);
			}, true);

			accountCancelButton.addEventListener("click", function(e)
			{
				hideSlate(accountElem);
				showSlate(dashboardElem);
			}, true);

			accountChangePasscodeButton.addEventListener("click", function(e)
			{
				accountChangePasscodeButton.style.display = "none";

				// Show the passcode elements.
				accountElem.querySelector(".passcodes").style.display = "block";
			}, true);

			accountElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				var username = accountUsername.value;
				var displayName = accountDisplayName.value;
				var oldPasscode = accountOldPublicPasscode.value;
				var newPasscode = accountNewPublicPasscode.value;
				var newPasscodeAgain = accountNewPublicPasscodeAgain.value;
				if( accountElem.querySelector(".passcodes").style.display !== "none" )
				{
					if( metaverse.encodePasscode(oldPasscode) !== metaverse.localUser.passcode )
					{
						error = "ERROR: Incorrect public passcode."
						console.log(error);
						alert(error);
						return;
					}
					if( newPasscode !== newPasscodeAgain )
					{
						error = "ERROR: New public passcodes do not match."
						console.log(error);
						alert(error);
						return;
					}
					if( !!!newPasscode || newPasscode.length <= 5 )
					{
						error = "ERROR: Public passcodes must be at least 6 characters long."
						console.log(error);
						alert(error);
						return;
					}
				}
				
				if( newPasscode !== "" )
					newPasscode = metaverse.encodePasscode(newPasscode);

				// Has anything changed?
				var changed = false;
				if( metaverse.localUser.displayName !== displayName )
					changed = true;
				else if( newPasscode !== "" && metaverse.localUser.passcode !== newPasscode )
					changed = true;

				if( changed )
				{
					var data = {};
					if( displayName !== "" )
						data.displayName = displayName;
					if( newPasscode !== "" )
						data.passcode = newPasscode;

					metaverse.updateLocalUser(data, function(error)
					{
						if( !!error )
						{
							console.log(error);
							alert(error);
							return;
						}

						// Hide the account slate.
						accountElem.parentNode.style.display = "none";

						// Show the dashboard slate.
						dashboardElem.parentNode.style.display = "block";
					});
				}
				else
				{
					hideSlate(accountElem);
					showSlate(dashboardElem);
				}
			}, true);

			metaverseLibraryCancelButton.addEventListener("click", function(e)
			{
				hideSlate(metaverseLibraryElem);
				showSlate(dashboardElem);
			}, true);

			metaverseLibraryItemsButton.addEventListener("click", function(e)
			{
				hideSlate(metaverseLibraryElem);
				showSlate(metaverseLibraryItemsElem);
			}, true);

			metaverseLibraryItemsCancelButton.addEventListener("click", function(e)
			{
				hideSlate(metaverseLibraryItemsElem);
				showSlate(metaverseLibraryElem);
			}, true);

			metaverseLibraryItemsCreateButton.addEventListener("click", function(e)
			{
				hideSlate(metaverseLibraryItemsElem);
				showSlate(metaverseLibraryItemsCreateElem);
			}, true);

			metaverseLibraryItemsCreateCancelButton.addEventListener("click", function(e)
			{
				hideSlate(metaverseLibraryItemsCreateElem);
				showSlate(metaverseLibraryItemsElem);
			}, true);

			metaverseLibraryItemsCreateElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				freezeInputs(metaverseLibraryItemsCreateElem);

				var file = metaverseLibraryItemsCreateFile.value;

				// Generate the item.
				var item = {};
				//item.id = metaverse.generateHash(file);
				item.title = metaverse.generateTitle(file);
				item.type = metaverse.generateType(file);
				item.file = file;
				item.app = "";
				item.description = "";
				item.preview = "";
				item.reference = "";
				item.model = "";
				item.marquee = "";
				item.screen = "";

				// Now that the item is constructed, let's check for an existing twin.
				metaverse.findTwin(item, function(twin)
				{
					if( !!twin )
					{
						error = "A version of that item already exists!";
						console.log(error);
						alert(error);

						unfreezeInputs(metaverseLibraryItemsCreateElem);
						return;
					}

					// Add the item.
					metaverse.createItem(item, function(resultId)
					{
						item.resultId = resultId;

						hideSlate(metaverseLibraryItemsCreateElem);
						showSlate(metaverseLibraryItemsElem);
					});
				});
			}, true);

			signUpCancelButton.addEventListener("click", function(e)
			{
				hideSlate(signUpElem);
				showSlate(dashboardElem);
			}, true);

			signUpElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				var username = signUpUsername.value;

				if( !!!username || username.length <= 5 )
				{
					error = "ERROR: Username must be at least 6 characters long."
					console.log(error);
					alert(error);
					return;
				}

				if( username.search(/[^A-Za-z0-9_]/) !== -1 || username[0].search(/[A-Za-z]/) === -1 )
				{
					error = "ERROR: Username may contain only alphanumeric characters, the under_score symbol, and must start with a letter.";
					console.log(error);
					alert(error);
					return;
				}

				var passcode = signUpPasscode.value;
				if( !!!passcode || passcode.length <= 5 )
				{
					error = "ERROR: Public passcodes must be at least 6 characters long."
					console.log(error);
					alert(error);
					return;
				}

				var displayName = signUpDisplayName.value;

				if( !!!displayName )
					displayName = "";

				// Create the new user.
				var data = {
					"username": username,
					"passcode": passcode,
					"displayName": displayName,
					"sessoins": {},
					"lastSeen": Firebase.ServerValue.TIMESTAMP,
					"created": Firebase.ServerValue.TIMESTAMP
				};

				data = metaverse.createUser(data);
				if( !!data )
				{
					hideSlate(signUpElem);
					showSlate(logInElem);

					logInPasscode.value = signUpPasscode.value;
					logInUsername.value = signUpUsername.value;
					logInLogInButton.click();
				}
				else
				{
					error = "ERROR: Username is already in use.";
					console.log(error);
					alert(error);
					return;	
				}
			}, true);

			dashboardLogInButton.addEventListener("click", function(e)
			{
				hideSlate(dashboardElem);
				showSlate(logInElem);
			});

			logInCancelButton.addEventListener("click", function(e)
			{
				hideSlate(logInElem);
				showSlate(dashboardElem);
			});

			logInElem.querySelector("form").addEventListener("submit", function(e)
			{
				e.preventDefault();

				var username = logInUsername.value;
				if( !!!username || username.length <= 5 )
				{
					error = "ERROR: Invalid username or passcode."
					console.log(error);
					alert(error);
					return;
				}

				if( username.search(/[^A-Za-z0-9_]/) !== -1 || username[0].search(/[A-Za-z]/) === -1 )
				{
					error = "ERROR: Invalid username or passcode.";
					console.log(error);
					alert(error);
					return;
				}

				var passcode = logInPasscode.value;
				if( !!!passcode || passcode.length <= 5 )
				{
					error = "ERROR: Invalid username or passcode."
					console.log(error);
					alert(error);
					return;
				}

				metaverse.logIn(username, passcode, function(error)
				{
					if( !!error )
					{
						console.log(error);
						alert(error);
						return;
					}

					hideSlate(logInElem);
					showSlate(dashboardElem);
				});
			});
		</script>
	</body>
</html>